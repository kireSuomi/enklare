<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <section>
      <input
        id="amount"
        placeholder="Please enter the amount of jokes you want to see (5-10)"
      />
      <select id="type">
        <option value="any">Any</option>
        <option value="single">Single</option>
        <option value="twopart">Twopart</option>
      </select>
      <button id="getJokes">Get jokes!</button>

      <div id="jokes"></div>

      <div id="statistics"></div>
      <div id="statistics_doubble"></div>
    </section>

    <script>
      const btnGetJokes = document.getElementById("getJokes");

      btnGetJokes.addEventListener("click", getJokes);

      function getJokeMarkupEl(joke) {
        const jokeDiv = document.createElement("div");

        if (joke.type === "twopart") {
          jokeDiv.innerHTML = `
            <h3>${joke.type} - ${joke.category}</h3>
            <p>${joke.setup}</p>
            <p>${joke.delivery}</p>
          `;
        } else {
          jokeDiv.innerHTML = `
            <h3>${joke.type}</h3>
            <p>${joke.joke}</p>
          `;
        }

        jokeDiv.innerHTML = jokeDiv.innerHTML.replaceAll(
          /(\w*a\w*)/gi,
          '<span style="color: blue;">$1</span>'
        );
        return jokeDiv;
      }

      function printJokes(jokes) {
        const jokesDiv = document.getElementById("jokes");
        jokesDiv.innerHTML = "";

        jokes.forEach((joke) => {
          jokesDiv.appendChild(getJokeMarkupEl(joke));
        });
      }

      function getLetterList(sum) {
        //Most common letter
        const letters = {};
        sum.split("").forEach((letter) => {
          letter = letter.toLocaleLowerCase();

          if (letter == " ") {
            return;
          }
          if (letters[letter]) {
            letters[letter]++;
          } else {
            letters[letter] = 1;
          }
        });

        return letters;
      }

      function getMostCommonLetter(sum) {
        const letters = getLetterList(sum);

        return Object.keys(letters).reduce(
          (acc, letter) => {
            if (letters[letter] > acc.count) {
              acc.count = letters[letter];
              acc.letters = [letter];
            } else if (letters[letter] === acc.count) {
              acc.letters.push(letter);
            }
            return acc;
          },
          { count: 0, letters: [] }
        );
      }

      function letterOccurence(sum, thirdLetter) {
        thirdLetter = thirdLetter.toLocaleLowerCase();
        sum = sum.toLocaleLowerCase();

        return sum.split("").reduce((acc, letter) => {
          leter = letter;
          if (letter === thirdLetter) {
            acc++;
          }
          return acc;
        }, 0);
      }

      function printStatistics(jokes) {
        const singleJokes = jokes.filter((joke) => joke.type === "single");
        const twoPartJokes = jokes.filter((joke) => joke.type === "twopart");

        //Single part jokes ========
        let singleSum = "";
        const totalCharsSingleJokes = singleJokes.reduce((acc, joke) => {
          singleSum += joke.joke;
          return acc + joke.joke.length;
        }, 0);

        if (singleJokes.length > 0) {
          const singleThirdLetter = singleJokes
            .reverse()[0]
            .joke.split(" ")
            .reverse(0)[0]
            .split("")[2]
            .toLocaleLowerCase();

          const singleThirdLetterOccurences = letterOccurence(
            singleSum,
            singleThirdLetter
          );
          const singleMostCommonLetter = getMostCommonLetter(singleSum);

          console.log(singleJokes);
          document.getElementById("statistics").innerHTML = `
            <h2>Statistics single:</h2>
            <p>Total chars: ${totalCharsSingleJokes}</p>
            <p>Third letter of the last joke occurence (${singleThirdLetter}): ${singleThirdLetterOccurences}</p>
            <p>Most commong letter: ${singleMostCommonLetter.letters[0]}</p>
          `;
        } else {
          document.getElementById("statistics").innerHTML = "";
        }

        //Two part jokes ========

        //All chars of the two part jokes
        if (twoPartJokes.length > 0) {
          let twoPartSum = "";
          const totalCharsTwoPartJokes = twoPartJokes.reduce((acc, joke) => {
            twoPartSum += joke.setup + joke.delivery;
            return acc + joke.setup.length + joke.delivery.length;
          }, 0);

          //third letter of last joke occurenct amount
          const doubbleThirdLetter = twoPartJokes
            .reverse()[0]
            .delivery.split(" ")
            .reverse(0)[0]
            .split("")[2]
            .toLocaleLowerCase();
          const doubbleThirdLetterOccurences = letterOccurence(
            twoPartSum,
            doubbleThirdLetter
          );
          const doubbleMostCommonLetter = getMostCommonLetter(twoPartSum);

          document.getElementById("statistics_doubble").innerHTML = `
            <h2>Statistics doubble:</h2>
            <p>Total chars: ${totalCharsTwoPartJokes}</p>
            <p>Third letter of the last joke occurence (${doubbleThirdLetter}): ${doubbleThirdLetterOccurences}</p>
            <p>Most commong letter: ${doubbleMostCommonLetter.letters[0]}</p>
          `;
        } else {
          document.getElementById("statistics_doubble").innerHTML = "";
        }
      }

      function getJokes() {
        const amount = document.getElementById("amount").value ?? undefined;
        const type = document.getElementById("type").value ?? undefined;

        console.log(amount, type);
        fetch(`/api/jokes?amount=${amount}&type=${type}`)
          .then((res) => {
            return res.json();
          })
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              //Print the jokes and statistics
              printJokes(data);
              printStatistics(data);
            }
          });
      }
    </script>
  </body>
</html>
